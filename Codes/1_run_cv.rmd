# Setup

```{r echo = F, include = FALSE, cache = F}
library(knitr)
library(tidyverse)
opts_chunk$set(
  fig.align = "center",
  fig.retina = 5,
  warning = F,
  message = F,
  cache = T,
  echo = F
)

#* source functions
fs::dir_ls(here::here("Codes/functions")) %>%
  lapply(., source)
```

# Prepare dataset

```{r }
difm_geo <-
  readRDS(here("Data/all_data.rds")) %>%
  #* generate data for spatial cross-validation
  mutate(split_data = list(
    spatial_clustering_cv(
      data,
      coords = c("Y", "X"),
      v = 20
    )
  )) %>%
  #* find a set of variables that are not very highly
  #* correlated with each other
  mutate(vars_with_low_cor = list(
    find_vars_to_keep(data[, ..x_vars_to_keep])
  ))
```

# Spatial CV of RF

```{r }
set.seed(893423)

RF_sp_cv <-
  difm_geo %>%
  #* create a table of hyper parameters to tune
  mutate(tune_pars = list(
    expand.grid(
      mtry = c(3, 5),
      min.node.size = c(5, 10, 15),
      sample.fraction = c(0.3, 0.4, 0.5),
      vars_set = list(x_vars_to_keep, vars_with_low_cor)
    ) %>%
      data.table()
  )) %>%
  #* spatial cross validation
  mutate(cv_results = list(
    mclapply(
      seq_len(nrow(tune_pars)),
      function(x) {
        print(x)
        cv_data <-
          run_sptial_cv_rf(
            split_data,
            mtry = tune_pars[x, mtry],
            min.node.size = tune_pars[x, min.node.size],
            sample.fraction = tune_pars[x, sample.fraction],
            x_vars = c("nrate", tune_pars[x, vars_set][[1]])
          ) %>%
          .[, `:=`(
            mtry = tune_pars[x, mtry],
            min.node.size = tune_pars[x, min.node.size],
            sample.fraction = tune_pars[x, sample.fraction],
            x_vars = tune_pars[x, vars_set]
          )]
        return(cv_data)
      },
      mc.cores = 9
    ) %>%
      rbindlist()
  )) %>%
  dplyr::select(id_field, cv_results) %>%
  unnest() %>%
  data.table()

saveRDS(RF_sp_cv, "Results/rf_sp_cv.rds")

# mtry() <- difm_geo$tune_pars[[1]][x, mtry]
# min.node.size <- difm_geo$tune_pars[[1]][x, min.node.size]
# sample.fraction <- difm_geo$tune_pars[[1]][x, sample.fraction]
# x_vars <- c("nrate", difm_geo$tune_pars[[1]][x, vars_set][[1]])

RF_sp_cv[, .SD[which.min(rmse_cv), ], by = id_field]
```

# Spatial CV of GAM

```{r }
# split_data <- temp$split_data[[1]]
# gam_formula <- temp$formula_short[[1]]

gam_sp_cv <-
  difm_geo %>%
  mutate(vars_ls = list(
    list(x_vars_to_keep, vars_with_low_cor)
  )) %>%
  mutate(cv_results = list(
    mclapply(
      vars_ls,
      function(x) {
        print(id_field)

        gam_formula <-
          paste0(
            "yield ~ s(nrate, k = 2) + ",
            paste0("I(nrate*", x, ")", collapse = " + "), " + ",
            paste0("s(", x, ", k = 3)", collapse = " + ")
          )

        cv_data <-
          run_sptial_cv_gam(
            split_data,
            gam_formula = gam_formula
          ) %>%
          .[, `:=`(
            vars = x,
            gam_formula = gam_formula
          )]
        return(cv_data)
      },
      mc.cores = 2
    ) %>%
      rbindlist()
  )) %>%
  dplyr::select(id_field, cv_results) %>%
  unnest() %>%
  data.table()

saveRDS(, "Results/gam_sp_cv.rds")

gam_sp_cv[, .SD[which.min(rmse_cv), ], by = id_field]
```
